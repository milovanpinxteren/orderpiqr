{% extends 'admin/change_list.html' %}
{% load static i18n %}
{% block content %}

<!-- Pick Lists — changelist tour -->
<script>
  (function () {
    function getTour(){ return (typeof introJs?.tour === "function") ? introJs.tour() : introJs(); }
    function el(s){ return document.querySelector(s); }

    // Only run when arriving from Orders → Pick Lists
    if (localStorage.getItem('opqr_tour') !== 'go_picklists') return;

    const tour = getTour();
    const steps = [];

    // Columns from list_display
    const thCode      = el('th.column-picklist_code') || el('#changelist thead th:nth-child(1)');
    const thDevice    = el('th.column-device')        || el('#changelist thead th:nth-child(2)');
    const thPickTime  = el('th.column-pick_time')     || el('#changelist thead th:nth-child(3)');
    const thDuration  = el('th.column-time_taken')    || el('#changelist thead th:nth-child(4)');
    const thSuccess   = el('th.column-successful')    || el('#changelist thead th:nth-child(5)');

    const searchInput = el('#searchbar') || el('input[name="q"]');
    const firstRowLink= el('#result_list tbody tr:first-child th a');

    // Devices link for the final step
    const devicesLink =
      el('#nav-sidebar .app-orderpiqrapp .model-device a') ||
      el('#nav-sidebar .model-device a') ||
      el('#content-main .model-device a') ||
      document.querySelector('a[href$="/orderpiqrApp/device/"]');

    steps.push({ intro: gettext("These are your Pick Lists — the actual picking tasks. They can be generated from Orders, or auto-created when scanning a QR that doesn't exist yet.") });

    if (thCode)     steps.push({ element: thCode,     position: "bottom", intro: gettext("Picklist code — unique ID used in the app/QRs.") });
    if (thDevice)   steps.push({ element: thDevice,   position: "bottom", intro: gettext("Device — who/what performed the picking (helps with accountability).") });
    if (thPickTime) steps.push({ element: thPickTime, position: "bottom", intro: gettext("Pick time — when the pick started.") });
    if (thDuration) steps.push({ element: thDuration, position: "bottom", intro: gettext("Time taken — how long the pick took (performance metric).") });
    if (thSuccess)  steps.push({ element: thSuccess,  position: "bottom", intro: gettext("Successful — overall result. Issues are investigated on the detail page.") });

    if (searchInput) steps.push({ element: searchInput, position: "bottom", intro: gettext("Search by device name or pick time to find a list quickly.") });

    if (firstRowLink) {
      steps.push({
        element: firstRowLink, position: "right",
        intro: gettext("Open a picklist to review item-level results: which products were picked, timing, and which items were not picked.")
      });
    }

    // Final step: highlight the Devices link (no auto-redirect)
    if (devicesLink) {
      steps.push({
        element: devicesLink, position: "left",
        intro: gettext("Next: <b>Devices</b> — manage which devices can scan and see who picked what.")
      });
    } else {
      steps.push({ intro: gettext("Next: open <b>Devices</b> to manage scanners and see who picked what.") });
    }

    tour.setOptions({
      steps,
      showProgress: true,
      exitOnOverlayClick: false,
      doneLabel: gettext("Close")
    });

    // Persist state if user manually clicks: detail or devices
    document.addEventListener('click', function(e){
      const a = e.target.closest('a[href*="/orderpiqrApp/picklist/"], a[href$="/orderpiqrApp/device/"]');
      if (!a) return;
      if (/\/orderpiqrApp\/picklist\/\d+\//.test(a.getAttribute('href') || '')) {
        localStorage.setItem('opqr_tour', 'on_picklist_detail');
      } else if (a.href.endsWith('/orderpiqrApp/device/')) {
        localStorage.setItem('opqr_tour', 'go_devices');
      }
    }, true);

    // Add explicit buttons on the last step (no auto-redirect)
    tour.onafterchange(function(){
      const isLast = (typeof tour.currentStep === 'function')
        ? tour.currentStep() === steps.length - 1
        : (tour._currentStep || 0) === steps.length - 1;
      if (!isLast) return;

      const btns = document.querySelector('.introjs-tooltipbuttons');
      if (!btns) return;

      // Only add "Go to Devices" if the link exists
      if (devicesLink && !btns.querySelector('.opqr-go-devices')) {
        const goDevices = document.createElement('button');
        goDevices.className = 'opqr-go-devices introjs-button';
        goDevices.textContent = gettext('Go to Devices');
        goDevices.onclick = function(){
          localStorage.setItem('opqr_tour', 'go_devices');
          window.location.href = '/admin/orderpiqrApp/device/';
        };
        btns.appendChild(goDevices);
      }

      // If there is a first row, offer quick open
      if (firstRowLink && !btns.querySelector('.opqr-open-first-picklist')) {
        const openFirst = document.createElement('button');
        openFirst.className = 'opqr-open-first-picklist introjs-button';
        openFirst.textContent = gettext('Open first picklist');
        openFirst.onclick = function(){
          localStorage.setItem('opqr_tour', 'on_picklist_detail');
          window.location.href = firstRowLink.href;
        };
        btns.appendChild(openFirst);
      }
    });

    tour.oncomplete(function(){});
    tour.onexit(function(){});

    tour.start();
  })();
</script>

<!-- Pick List — change form (detail) tour -->
<script>
  (function () {
    function getTour(){ return (typeof introJs?.tour === "function") ? introJs.tour() : introJs(); }
    function el(s){ return document.querySelector(s); }

    // Only run when we navigated from the Pick Lists list
    if (localStorage.getItem('opqr_tour') !== 'on_picklist_detail') return;

    const tour = getTour();
    const steps = [];

    // Inline (ProductPick) table selectors (Django admin inlines)
    const inlineWrapper = el('#picklist_set-group, .inline-group'); // generic inline container
    // More specific: first inline table headers
    const thProd     = el('.inline-group table thead th:has(> .column-product), .inline-group table thead th:nth-child(1)');
    const thQty      = el('.inline-group table thead th:has(> .column-quantity), .inline-group table thead th:nth-child(2)');
    const thItemTime = el('.inline-group table thead th:has(> .column-time_taken), .inline-group table thead th:nth-child(3)');
    const thItemOK   = el('.inline-group table thead th:has(> .column-successful), .inline-group table thead th:nth-child(4)');

    // Page-level fields (read-only or main form)
    const fieldPickTime = el('#id_pick_time')?.closest('.form-row') || el('.form-row.field-pick_time');
    const fieldDuration = el('#id_time_taken')?.closest('.form-row') || el('.form-row.field-time_taken');
    const fieldSuccess  = el('#id_successful')?.closest('.form-row') || el('.form-row.field-successful');

    steps.push({ intro: gettext("This picklist shows item-level results. Use it to review issues and performance.") });

    if (fieldPickTime) steps.push({ element: fieldPickTime, position: "bottom", intro: gettext("Pick time — when the pick started.") });
    if (fieldDuration) steps.push({ element: fieldDuration, position: "bottom", intro: gettext("Total time taken — duration of this picklist.") });
    if (fieldSuccess)  steps.push({ element: fieldSuccess,  position: "bottom", intro: gettext("Overall success — quick status at a glance.") });

    if (inlineWrapper) steps.push({ element: inlineWrapper, position: "top", intro: gettext("Item-level results (Product Picks). Each row shows what happened per product.") });

    if (thProd)     steps.push({ element: thProd,     position: "bottom", intro: gettext("Product — what was supposed to be picked.") });
    if (thQty)      steps.push({ element: thQty,      position: "bottom", intro: gettext("Quantity — units picked for this product.") });
    if (thItemTime) steps.push({ element: thItemTime, position: "bottom", intro: gettext("Time taken — how long this item took to pick.") });
    if (thItemOK)   steps.push({ element: thItemOK,   position: "bottom", intro: gettext("Successful — if not checked, this item was not picked successfully.") });

    // Final note
    steps.push({ intro: gettext("Tip: items not picked (unsuccessful) help you spot shortages or scanning mistakes.") });

    tour.setOptions({
      steps,
      showProgress: true,
      exitOnOverlayClick: false,
      doneLabel: gettext("Close")
    });

    // When done with the detail, default back to Pick Lists context (no redirect)
    tour.oncomplete(function(){
      // Keep user context; clear only this flag so list-page tour can be re-run if needed
      localStorage.removeItem('on_picklist_detail'); // NOTE: localStorage keys are strings; we used the value, not key
      // Keep go_picklists or go_devices unchanged
    });

    tour.onexit(function(){});

    tour.start();
  })();
</script>

{% endblock %}
