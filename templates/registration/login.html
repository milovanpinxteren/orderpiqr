{% extends "registration/base_auth.html" %}
{% load static i18n %}

{% block title %}{% trans "Login" %} - OrderPiqR{% endblock %}

{% block content %}
<div class="auth-card">
    <div class="auth-header">
        <img src="{% static 'orderpiqrApp/img/favicon.png' %}" alt="OrderPiqR" class="auth-logo">
        <h1 class="auth-title">{% trans "Welcome back" %}</h1>
        <p class="auth-subtitle">{% trans "Sign in to your OrderPiqR account" %}</p>
    </div>

    <div class="auth-body">
        {% if form.non_field_errors %}
        <div class="alert alert-error">
            {% for error in form.non_field_errors %}
            <div>{{ error }}</div>
            {% endfor %}
        </div>
        {% endif %}

        {% if messages %}
        {% for message in messages %}
        <div class="alert alert-{{ message.tags|default:'success' }}">
            {{ message }}
        </div>
        {% endfor %}
        {% endif %}

        <form id="login-form" method="POST">
            {% csrf_token %}

            <div class="form-group">
                <label class="form-label required" for="id_username">{% trans "Username" %}</label>
                <input type="text"
                       class="form-control {% if form.username.errors %}error{% endif %}"
                       id="id_username"
                       name="username"
                       value="{{ form.username.value|default:'' }}"
                       placeholder="{% trans 'Enter your username' %}"
                       autofocus
                       required>
                {% if form.username.errors %}
                <span class="form-error">{{ form.username.errors.0 }}</span>
                {% endif %}
            </div>

            <div class="form-group">
                <label class="form-label required" for="id_password">{% trans "Password" %}</label>
                <input type="password"
                       class="form-control {% if form.password.errors %}error{% endif %}"
                       id="id_password"
                       name="password"
                       placeholder="{% trans 'Enter your password' %}"
                       required>
                {% if form.password.errors %}
                <span class="form-error">{{ form.password.errors.0 }}</span>
                {% endif %}
            </div>

            <div class="auth-links">
                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                    <input type="checkbox" name="remember" style="width: 16px; height: 16px; accent-color: var(--primary);">
                    <span style="font-size: 0.875rem; color: var(--text-secondary);">{% trans "Remember me" %}</span>
                </label>
                <a href="{% url 'password_reset' %}">{% trans "Forgot password?" %}</a>
            </div>

            <div style="margin-top: 24px;">
                <button type="submit" class="btn btn-primary">
                    {% trans "Sign in" %}
                </button>
            </div>
        </form>
    </div>

    <div class="auth-footer">
        {% trans "New to OrderPiqR?" %}
        <a href="{% url 'signup' %}">{% trans "Create your account" %}</a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script type="text/javascript">
    (function() {
        const STORAGE_KEY = 'orderpiqr_device_id';
        let deviceId = localStorage.getItem(STORAGE_KEY);
        if (!deviceId) {
            deviceId = (typeof crypto !== 'undefined' && crypto.randomUUID)
                ? crypto.randomUUID()
                : 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    const r = Math.random() * 16 | 0;
                    const v = c === 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            localStorage.setItem(STORAGE_KEY, deviceId);
        }
        const form = document.getElementById('login-form');
        const fingerprintInput = document.createElement('input');
        fingerprintInput.type = 'hidden';
        fingerprintInput.name = 'device_fingerprint';
        fingerprintInput.value = deviceId;
        form.appendChild(fingerprintInput);
    })();
</script>
{% endblock %}
